generator client {
  provider   = "prisma-client"
  output     = "../generated/prisma"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum GoalStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  xp Int @default(0)

  streak     Int @default(0)
  bestStreak Int @default(0)

  goals  Goal[]
  habits Habit[]
  steps  Step[]

  userBadges UserBadge[] @relation("UserToUserBadge") // <-- ajouté

  @@map("users")
}

model Goal {
  id          String     @id @default(uuid())
  title       String
  startDate   DateTime?
  deadline    DateTime?
  priority    Priority   @default(MEDIUM)
  status      GoalStatus @default(TODO)
  description String?
  category    String?
  userId      String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  xpReward Int @default(100)

  steps Step[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@map("goals")
}

model Habit {
  id               String    @id @default(uuid())
  title            String
  frequency        String    @default("DAILY")
  category         String
  description      String?
  isCompletedToday Boolean   @default(false)
  currentStreak    Int       @default(0)
  lastCompletedAt  DateTime?
  userId           String

  xpReward Int @default(20)

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  steps     HabitStep[]
  habitLogs HabitLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("habits")
}

model HabitStep {
  id          String  @id @default(uuid())
  title       String
  isCompleted Boolean @default(false)
  habitId     String
  order       Int     @default(0)

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  habitLogs HabitLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([habitId])
  @@map("habit_steps")
}

model HabitLog {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  isCompleted Boolean  @default(false)
  habitId     String

  habitStepId String?
  habitStep   HabitStep? @relation(fields: [habitStepId], references: [id])

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([habitId])
  @@index([date])
  @@map("habit_logs")
}

model Step {
  id           String   @id @default(uuid())
  title        String
  description  String?
  userId       String
  is_completed Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  order Int @default(0) // Pour trier (1, 2, 3...)

  // Relation One-to-Many
  goalId String
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("steps")
}

model Badge {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String // URL ou nom de l'icône
  condition   String   @unique// ex: "7_days_streak", "10_goals_completed"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userBadges UserBadge[]

  @@map("badges")
}

model UserBadge {
  id         String   @id @default(uuid())
  userId     String
  badgeId    String
  unlockedAt DateTime @default(now())

  user  User  @relation("UserToUserBadge", fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}
